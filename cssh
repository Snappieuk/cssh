#!/bin/bash

SCRIPT_NAME="cssh"
TARGET_PATH="/usr/local/bin/$SCRIPT_NAME"

# Extract IPs from "Membership information" section of pvecm status
nodes=$(pvecm status | awk '/Membership information/{flag=1;next} flag && NF{print $3}' | sed 's/(local)//')

# Trim whitespace
nodes=$(echo "$nodes" | xargs)

# Debug helper
if [[ "$1" == "--list" ]]; then
  echo "Discovered nodes:"
  echo "$nodes"
  exit 0
fi

if [[ -z "$nodes" ]]; then
  echo "No nodes discovered (check 'pvecm status')."
  exit 1
fi

# --parallel flag
if [[ "$1" == "--parallel" ]]; then
  shift
  if [ -z "$1" ]; then
    echo "Usage: $0 --parallel [command]"
    exit 1
  fi

  echo "Running command in parallel across nodes..."
  for node in $nodes; do
    echo "-- $node ----------------------------------------"
    ssh -T root@"$node" -- "$@" &
  done
  wait
  echo "Parallel execution complete."
  exit 0
fi

# Default: sequential
if [[ -z "$1" ]]; then
  echo "Usage: $0 [--list] [--parallel] [command]"
  exit 1
fi

for node in $nodes; do
  echo "-- $node ----------------------------------------"
  ssh -T root@"$node" -- "$@"
done
